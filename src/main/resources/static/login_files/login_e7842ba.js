riot.tag("loginBox",'<div if="{options.tabs.length>0}" class="y-box login-header"> <div each="{item, i in options.tabs}" onmouseover="{mouseOver}" class="y-left item {active: options.activeType === i}"> <span>{item.name}</span> </div> </div> <div class="login-type">  <div if="{options.activeType == 1}" riot-tag="baseLogin" service="{opts.service}" captcha="{opts.captcha}" hidesns="{opts.hidesns}"></div> </div>','class="loginBox"',function(){this.options={tabs:[],activeType:1},this.mouseOver=function(o){this.options.activeType=o.item.i}.bind(this)}),riot.tag("baseLogin",'<div class="baseLogin"> <div if="{options.errorMsg}" class="error-msg"> <i class="y-icon icon-errormessage"></i> {options.errorMsg} <i onclick="{onErrorMsgClick}" class="y-right y-icon icon-clearicon"></i> </div> <form action="/auth/login/" method="POST" onsubmit="{onFormSubmit}"> <div if="{options.mode==1}" class="input-field"> <input id="mobile" type="text" name="mobile" autocomplete="off" spellcheck="false" placeholder="手机号"> </div> <div if="{options.mode==1&&options.captcha}" class="input-field verification"> <input id="captcha1" type="text" name="captcha1" autocomplete="off" spellcheck="false" placeholder="验证码"> <div class="captcha-wrap"> <img class="y-right captcha" riot-src="data:image/gif;base64,{options.captcha}" alt="" onclick="{refreshCaptcha}"> <span class="tips-bubble">看不清楚？换一张</span> </div> </div> <div if="{options.mode==1}" class="input-field phone-code"> <input id="code" type="text" name="code" autocomplete="off" spellcheck="false" placeholder="手机验证码"> <span class="code-btn {active: options.isCodeSending}" onclick="{getCodeClick}">{options.codeStatus}</span> </div> <div if="{options.mode==2}" class="input-field"> <input id="account" type="text" name="account" autocomplete="off" spellcheck="false" placeholder="邮箱/手机号"> </div> <div if="{options.mode==2}" class="input-field"> <input id="password" type="password" name="password" autocomplete="off" spellcheck="false" placeholder="密码"> </div> <div if="{options.mode==2&&options.captcha}" class="input-field verification"> <input id="captcha" type="text" name="captcha" autocomplete="off" spellcheck="false" placeholder="验证码"> <div class="captcha-wrap"> <img class="y-right captcha" riot-src="data:image/gif;base64,{options.captcha}" alt="" onclick="{refreshCaptcha}"> <span class="tips-bubble">看不清楚？换一张</span> </div> </div> <div class="y-box action">  <input id="agreement" class="agreement" type="checkbox" name="agreement" checked="checked"> <label for="agreement">我已阅读并同意<a href="https://www.toutiao.com/user_agreement/" target="_blank">用户协议</a>和<a href="https://www.toutiao.com/privacy_protection/" target="_blank">隐私条款</a></label> <a if="{options.source==1&&options.mode==2}" class="forget" href="http://mp.toutiao.com/forget/" target="_blank">忘记密码</a> <a if="{options.source==0&&options.mode==2}" class="forget" href="https://sso.toutiao.com/forget_password/?cb={options.encodeService}" target="_blank">忘记密码</a> </div> <input type="submit" name="submitBtn" class="action-btn" value="登录"> </form> <ul if="{!options.hidesns}" class="sns-login" onclick="{snsLoginClick}"> <li class="sns {phone-login: options.mode==2} {mail-login: options.mode==1}" data-pid="mail_phone"> <span>{options.snsName}</span> </li> <li class="sns qq-login" data-pid="qzone_sns"> <span>QQ</span> </li> <li class="sns weixin-login" data-pid="weixin"> <span>微信</span> </li> </ul> </div>',function(o){function t(){for(var o=location.search.slice(1),t={},i=o.split("&"),e=0,s=i.length;s>e;e++){var a,n=i[e];""!==n.replace(/^\s+|\s+$/g,"")&&(a=n.split("="),t[a[0]]=a[1])}return t}function i(o){var t="https://www.toutiao.com/auth/connect/?type=sso";t+="&platform="+o,t+="&next=https://sso.toutiao.com/auth/login_success/?service="+u,window.location.href=t}function e(){if(1==r.options.mode){if(""==r.mobile.value.trim()||""==r.code.value.trim())return!1;if(r.options.captcha&&""==r.captcha1.value.trim())return!1}if(2==r.options.mode){if(""==r.account.value.trim()||""==r.password.value.trim())return!1;if(r.options.captcha&&""==r.captcha.value.trim())return!1}return!0}function s(){var o,t=60;o=setInterval(function(){return 0===t?(clearInterval(o),o=null,r.options.isCodeSending=!1,r.options.codeStatus="获取验证码",void r.update()):(r.options.codeStatus=t+"s重新获取",t--,void r.update())},1e3)}function a(){var o="";o=1==r.options.mode?r.captcha1&&r.captcha1.value:r.captcha&&r.captcha.value;var t={mobile:r.mobile&&r.mobile.value,code:r.code&&r.code.value,account:r.account&&r.account.value,password:r.password&&r.password.value,captcha:o,is_30_days_no_login:!1,service:u};return t}var n=t();if(n.cb)var c=decodeURIComponent(n.cb);else c="";var r=this,p="/quick_login/",l="/refresh_captcha/",d=!1,u=c||o.service,h={0:"您输入的手机号或验证码不匹配",1:"您输入的帐号或密码不匹配",2:"您输入的信息不完整",3:"验证码获取失败",4:"为了您的帐户安全，请输入图片验证码",5:"请输入正确的图片验证码",6:"需要阅读并同意用户协议和隐私条款",7:"为保证安全，请使用手机验证码登录"};this.options={source:0,snsName:"帐号",mode:1,captcha:o.captcha||"",errorMsg:"",isCodeSending:!1,codeStatus:"获取验证码",encodeService:encodeURIComponent(u),hidesns:o.hidesns||!1},this.on("mount",function(){if(!this.options.hidesns){u.indexOf("mp.toutiao.com")>-1&&(this.options.source=1,this.options.snsName="手机",this.options.mode="2",p="/account_login/"),this.update();var o=/www.toutiao.com/g,t=o.test(document.referrer);t&&window.taAnalysis&&taAnalysis.send("event",{ev:"sso_from_pc"})}}),this.onFormSubmit=function(o){return o.preventDefault(),window.taAnalysis&&taAnalysis.send("event",{ev:"sso_login_click"}),e()?r.agreement.checked?void(d||(d=!0,this.submitBtn.value="登录中...",http({url:p,method:"POST",data:a(),headers:{"X-CSRFToken":Cookies.get("csrftoken")},success:function(o){0==o.error_code?(window.taAnalysis&&taAnalysis.send("event",{ev:"sso_login_success"}),window.location.href=c?c:o.redirect_url||u):(r.options.captcha=o.captcha||"",r.options.errorMsg=1==r.options.mode?h[0]:h[1],r.options.captcha&&(r.options.errorMsg=h[4]),1102==o.error_code&&(r.options.errorMsg=h[5]),1039==o.error_code&&(r.options.errorMsg=h[7],r.options.mode=1,r.options.snsName="帐号",p="/quick_login/")),d=!1,r.submitBtn.value="登录",r.update()},error:function(){r.submitBtn.value="登录"}}))):(this.options.errorMsg=h[6],!1):void(this.options.errorMsg=h[2])}.bind(this),this.getCodeClick=function(){return this.options.isCodeSending?void 0:""==r.mobile.value.trim()?void(this.options.errorMsg=h[2]):void http({url:"/send_activation_code/",data:{mobile:r.mobile&&r.mobile.value,captcha:r.captcha1&&r.captcha1.value,type:24},method:"get",success:function(o){0===o.error_code?(r.options.isCodeSending=!0,s()):(r.options.captcha=o.captcha||"",r.options.errorMsg=h[3],r.options.captcha&&(r.options.errorMsg=h[4]),1102==o.error_code&&(r.options.errorMsg=h[5]),1003==o.error_code&&(r.options.errorMsg=o.description||"请求失败")),r.update()}})}.bind(this),this.snsLoginClick=function(o){var t,e=utils.getTarget(o);"li"==e.tagName.toLowerCase()&&(t=utils.getAttribute(e,"data-pid"),"mail_phone"==t?(this.options.mode=1==this.options.mode?2:1,this.options.snsName=1==this.options.mode?"帐号":"手机",p=1==this.options.mode?"/quick_login/":"/account_login/"):i(t))}.bind(this),this.onErrorMsgClick=function(){this.options.errorMsg=""}.bind(this),this.refreshCaptcha=function(){http({url:l,method:"get",success:function(o){o.captcha?r.options.captcha=o.captcha:r.options.errorMsg=h[4],r.update()}})}.bind(this)});